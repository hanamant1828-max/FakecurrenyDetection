{% extends "base.html" %}

{% block title %}Testing Dashboard - Fake Currency Detector{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">üß™ Testing Dashboard</h1>
        <p class="card-subtitle">Test and debug your currency detection model</p>
    </div>

    <div class="loading" id="modelLoading">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: var(--text-medium);">Loading model information...</p>
    </div>

    <div id="modelInfo"></div>
</div>

<div class="card">
    <h2 style="font-size: 1.5em; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--bg-light); color: var(--text-dark);">üî¨ Quick Test</h2>
    
    <div class="upload-area" id="testUploadArea">
        <div style="font-size: 3em; margin-bottom: 15px;">üì∏</div>
        <div style="font-size: 1.2em; margin-bottom: 10px; color: var(--text-medium);">Upload Currency Image for Testing</div>
        <div style="color: var(--text-light); font-size: 0.9em;">PNG, JPG or JPEG (max 16MB)</div>
        <input type="file" id="testFileInput" accept="image/png,image/jpeg,image/jpg" multiple>
    </div>

    <div id="previewArea" style="margin: 20px 0;"></div>

    <div class="text-center">
        <button class="btn" id="testBtn" style="display: none;">Run Test</button>
        <button class="btn btn-secondary" id="clearBtn" style="display: none;">Clear All</button>
    </div>

    <div class="loading" id="testLoading">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: var(--text-medium);">Testing images...</p>
    </div>

    <div id="testResults" style="display: none; margin-top: 20px;">
        <h3 style="margin-bottom: 15px;">Test Results:</h3>
        <div id="resultsContainer"></div>
    </div>
</div>

<div class="card">
    <h2 style="font-size: 1.5em; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--bg-light); color: var(--text-dark);">üèóÔ∏è Model Architecture</h2>
    <div id="layersInfo" style="max-height: 400px; overflow-y: auto; background: var(--bg-light); padding: 15px; border-radius: 10px;">
        <p style="color: var(--text-medium);">Loading layers information...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedFiles = [];
    const testUploadArea = document.getElementById('testUploadArea');
    const testFileInput = document.getElementById('testFileInput');
    const testBtn = document.getElementById('testBtn');
    const clearBtn = document.getElementById('clearBtn');
    const previewArea = document.getElementById('previewArea');
    const testLoading = document.getElementById('testLoading');
    const testResults = document.getElementById('testResults');
    const resultsContainer = document.getElementById('resultsContainer');

    window.addEventListener('DOMContentLoaded', loadModelInfo);

    function loadModelInfo() {
        document.getElementById('modelLoading').style.display = 'flex';

        fetch('/model-info')
            .then(response => response.json())
            .then(data => {
                document.getElementById('modelLoading').style.display = 'none';
                displayModelInfo(data);
                displayLayers(data.layers);
            })
            .catch(error => {
                document.getElementById('modelLoading').style.display = 'none';
                alert('Failed to load model information: ' + error.message);
            });
    }

    function displayModelInfo(data) {
        const statusClass = data.model_type.includes('Demo') ? 'badge-demo' : 'badge-trained';
        const html = `
            <div class="grid grid-2">
                <div style="background: var(--bg-light); padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary-color);">
                    <div style="font-weight: 600; color: var(--text-medium); font-size: 0.9em; margin-bottom: 5px;">Model Status</div>
                    <div><span class="badge ${statusClass}">${data.model_type}</span></div>
                </div>
                <div style="background: var(--bg-light); padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary-color);">
                    <div style="font-weight: 600; color: var(--text-medium); font-size: 0.9em; margin-bottom: 5px;">Total Layers</div>
                    <div style="color: var(--text-dark); font-size: 1.1em;">${data.total_layers}</div>
                </div>
                <div style="background: var(--bg-light); padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary-color);">
                    <div style="font-weight: 600; color: var(--text-medium); font-size: 0.9em; margin-bottom: 5px;">Input Shape</div>
                    <div style="color: var(--text-dark); font-size: 1.1em;">${data.input_shape}</div>
                </div>
                <div style="background: var(--bg-light); padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary-color);">
                    <div style="font-weight: 600; color: var(--text-medium); font-size: 0.9em; margin-bottom: 5px;">Output Classes</div>
                    <div style="color: var(--text-dark); font-size: 1.1em;">${data.class_names.join(', ')}</div>
                </div>
            </div>
        `;
        document.getElementById('modelInfo').innerHTML = html;
    }

    function displayLayers(layers) {
        const html = layers.map(layer => `
            <div style="padding: 10px; margin-bottom: 8px; background: white; border-radius: 5px; border-left: 3px solid var(--primary-color);">
                <div style="font-weight: 600; color: var(--text-dark);">${layer.name}</div>
                <div style="color: var(--text-medium); font-size: 0.9em;">${layer.type} | Output: ${layer.output_shape}</div>
            </div>
        `).join('');
        document.getElementById('layersInfo').innerHTML = html;
    }

    testUploadArea.addEventListener('click', () => testFileInput.click());

    testFileInput.addEventListener('change', (e) => {
        handleFiles(Array.from(e.target.files));
    });

    testUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        testUploadArea.classList.add('dragover');
    });

    testUploadArea.addEventListener('dragleave', () => {
        testUploadArea.classList.remove('dragover');
    });

    testUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        testUploadArea.classList.remove('dragover');
        handleFiles(Array.from(e.dataTransfer.files));
    });

    function handleFiles(files) {
        selectedFiles = files;
        displayPreviews(files);
        testBtn.style.display = 'inline-block';
        clearBtn.style.display = 'inline-block';
        testResults.style.display = 'none';
    }

    function displayPreviews(files) {
        previewArea.innerHTML = '';
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.cssText = 'max-width: 200px; max-height: 200px; border-radius: 10px; margin: 10px;';
                previewArea.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }

    clearBtn.addEventListener('click', () => {
        selectedFiles = [];
        previewArea.innerHTML = '';
        testBtn.style.display = 'none';
        clearBtn.style.display = 'none';
        testResults.style.display = 'none';
        testFileInput.value = '';
    });

    testBtn.addEventListener('click', async () => {
        if (selectedFiles.length === 0) return;

        testLoading.style.display = 'flex';
        testResults.style.display = 'none';
        resultsContainer.innerHTML = '';

        let successCount = 0;
        const results = [];

        for (const file of selectedFiles) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    successCount++;
                    results.push({
                        filename: file.name,
                        success: true,
                        data: data
                    });
                } else {
                    results.push({
                        filename: file.name,
                        success: false,
                        error: data.error
                    });
                }
            } catch (error) {
                results.push({
                    filename: file.name,
                    success: false,
                    error: error.message
                });
            }
        }

        testLoading.style.display = 'none';
        displayResults(results);
    });

    function displayResults(results) {
        const html = results.map(result => {
            if (result.success) {
                const borderColor = result.data.is_genuine ? 'var(--success-color)' : 'var(--danger-color)';
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: var(--bg-light); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid ${borderColor};">
                        <div>
                            <strong>${result.filename}</strong><br>
                            <span style="font-size: 1.2em;">${result.data.prediction}</span> 
                            (${result.data.confidence}% confidence)
                        </div>
                        <div style="text-align: right;">
                            <div>Fake: ${result.data.probabilities.fake}%</div>
                            <div>Genuine: ${result.data.probabilities.genuine}%</div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div style="background: var(--bg-light); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--warning-color);">
                        <strong>${result.filename}</strong><br>
                        <span style="color: var(--warning-color);">Error: ${result.error}</span>
                    </div>
                `;
            }
        }).join('');

        resultsContainer.innerHTML = html;
        testResults.style.display = 'block';
    }
</script>
{% endblock %}
